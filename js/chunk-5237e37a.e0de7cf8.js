(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-5237e37a","chunk-2d22d73d","chunk-2d0e278f","chunk-2d21e194","chunk-770c723c","chunk-2d0df0c0","chunk-2d0aad2b","chunk-2d0ddb70"],{"133f":function(s,t,a){s.exports=a.p+"img/1678092571872.58760127.png"},"7f9c":function(s,t,a){s.exports=a.p+"img/1677136009659.32cf46c7.png"},8321:function(s,t,a){s.exports=a.p+"img/1678093372704.2ec7c0af.png"},"87f1":function(s,t,a){s.exports=a.p+"img/1678092462283.63b9b8f5.png"},c532c:function(s,t,a){s.exports=a.p+"img/1677137983405.32bed19c.jpg"},d3b1:function(s,t,a){s.exports=a.p+"img/1677136496009.d5ebe235.png"},dae9:function(s,t,a){"use strict";a.r(t);var n=function(){var s=this,t=s.$createElement;s._self._c;return s._m(0)},r=[function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("section",[n("html",[n("head"),n("body",[n("h1",[s._v("ElasticSearch-基础篇")]),n("h1",[s._v("1、倒排索引")]),n("h2",[s._v("1.1、倒排索引创建的过程")]),n("ul",[n("li",[s._v("搜索引擎中存储的是倒排索引，就是分好的词和词语文章的关联。")]),n("li",[s._v("实现把文章中词进行打散，以词为依据，然后关联上对应的文章。")]),n("li",[s._v("查询的时候，就是根据查词语找对对应的文章。")])]),n("p",[n("img",{attrs:{src:a("c532c"),alt:""}})]),n("h2",[s._v("1.2、搜索过程")]),n("ul",[n("li",[s._v("当用户搜索任意词条时，首先对用户输入的文本进行分词，获取需要搜索的词条。")]),n("li",[s._v("然后通过这个词条到倒排索引中去查询命中的词语。")]),n("li",[s._v("然后在根据这些命中的词语获取对应的文档id。")]),n("li",[s._v("然后在根据这些ID去获取文档数据。")])]),n("h1",[s._v("2、ES集群")]),n("p",[s._v("ES集群是由多个节点组成，通过cluster.name设置集群名字，并且用于区分其他集群，集群中每一个节点通过node.name指定节点名称。")]),n("p",[s._v("在ES集群中，存在的节点类型主要有四种。")]),n("ul",[n("li",[n("p",[s._v("master节点：")]),n("ul",[n("li",[s._v("节点配置文件的node.master属性值为true，默认值也为true，表示该节点在集群中有可能被选举成主节点。")]),n("li",[s._v("master节点控制整个集群的操作，比如：创建，删除索引的操作，管理其他非master节点。")])])]),n("li",[n("p",[s._v("data节点：")]),n("ul",[n("li",[s._v("节点配置文件的node.data属性值为true，默认值也是true，表示该节点在集群中有可能成为数据节点。")]),n("li",[s._v("data节点主要的用于对文档数据的操作。比如：对文档的CURD操作。")])])]),n("li",[n("p",[s._v("协调节点：")]),n("ul",[n("li",[s._v("配置文件中node.data 和node.master均为false。")]),n("li",[s._v("该节点不能作为主节点和数据节点。")]),n("li",[s._v("可以用来的响应用户的请求，把请求转发到其他节点。")])])])]),n("h1",[s._v("3、分片和副本")]),n("p",[s._v("添加数据到ES中，需要创建一个索引，一个用来存储数据的地方。其实索引只是用来指向一个分片或多个分片的逻辑命名空间。")]),n("ul",[n("li",[s._v("一个分片（shard）是一个最小级别的工作单元，分片只是保存索引中一小部分数据。")]),n("li",[s._v("一个分片就是一个lucene实例，并且它本身就一个完整的搜索引擎，应用程序不会直接和它通讯。")]),n("li",[s._v("分片可以分为主分片和复制分片。")]),n("li",[s._v("复制分片是主分片的一个副本，是防止主分片挂掉，造成数据丢失。")]),n("li",[s._v("当索引创建完成后，主分片的数量就固定了，但是复制分片的数量是可以调整的。")])]),n("p",[s._v("每一个索引上的数据会存在多个分片中，默认创建的索引是分片五个分片进行存储的，每一个分片都部署在分布式环境下多个节点上存。**索引的主分片定义好了，就不能在进行修改了。**为了数据的高可用，主分片可以对应多个复制分片，主分片和复制分片不能存放在同一台服务器上，避免服务宕机后，这个主分片的数据就丢失。")]),n("h1",[s._v("4、数据路由")]),n("p",[s._v("当客户端发起创建document的请求时，ES需要计算出该document存储在索引的哪一个分片上，这个过程就是数据路由。")]),n("p",[s._v("计算公式：")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":""}},[s._v("路由算法：shard = hash(routing) % number_of_primary_shards\n")])]),n("p",[s._v("如果在查询数据时number_of_primary_shards发生变化，就无法获取数据。")]),n("p",[n("strong",[s._v("所以：主分区一旦确定了，就不能进行修改。")])]),n("ul",[n("li",[s._v("routing：是一个任意的字符串，它默认是文档的id，但是也可以自定义。")]),n("li",[s._v("这个routing字符串通过hash函数生成一个数字，然后除以主分片数量的余数。这个余数就是0 - 主分片 - 1的范围。")])]),n("h1",[s._v("5、ES操作原理")]),n("h2",[s._v("5.1、插入文档")]),n("p",[n("img",{attrs:{src:a("f80e"),alt:""}})]),n("p",[s._v("新建文档的流程：")]),n("ul",[n("li",[s._v("client向node1发送新建请求，协调节点，通过hash算法可以计算可以计算出在哪一个分片上，然后路由到对应的节点 shard = hash(document_id) % number_of_primary)_shards。")]),n("li",[s._v("节点使用文档_id确定文档属于分片0，请求就会被转发到node3上，因为分片0在node3节点上。")]),n("li",[s._v("在node3上请求执行成功后，它就会将node3的分片0将数据复制到node1和node2上面，一旦所有的复制分片复制成功后，node3就向协调节点报告成功，协调节点向客户端报告成功。")])]),n("h2",[s._v("5.2、更新文档")]),n("p",[n("img",{attrs:{src:a("7f9c"),alt:""}})]),n("ul",[n("li",[s._v("客户端想node1发送一个请求，node1作为协调节点，会根据文档id计算出该文档属于哪一个分片上，计算方法于上面数据路由计算方式一样。")]),n("li",[s._v("计算出该文档在分片0上，分片0在node3上，然后在将请求转发到node3上。")]),n("li",[s._v("node3上主分片检索文档，修改文档中source中数据。")]),n("li",[s._v("node3更新成功后，主分片就会将更新的数据分复制到node1和node2上副本分片上，当所有副本分片都返回成功后，node3向协调节点返回。此时协调节点会响应给client。")])]),n("h2",[s._v("5.3、删除文档")]),n("p",[n("img",{attrs:{src:a("d3b1"),alt:""}})]),n("p",[s._v("该过程可以分为一些四个阶段：")]),n("ul",[n("li",[s._v("客户端向node1发送一个删除文档的请求。")]),n("li",[s._v("于上面相同，node1会计算除该文档处于哪一个分片上，但是操作是操作的主分片，计算得出需要操作分片在node3上。")]),n("li",[s._v("将请求转发到node3上，需要在主分片上操作。如果在node3上主分支删除成功后，会复制到所有副本分片上。")]),n("li",[s._v("当所有的副本分片成功后，才会返回到协调节点上，协调节点返回给client端。")])]),n("p",[s._v("ES是建立在lucene基础上的实时的分布式搜索引擎，lucene为了提高搜索的效率，所有lucene中的数据是不允许被修改的，这些文档存放在segment中，也就是说，一个segment写到存储系统中，就不能被修改的，lucene是如何删除一个文档呢？")]),n("ul",[n("li",[s._v("当用户发送一个删除请时，会先搜索到该文档。")]),n("li",[s._v("然后通过一个标记，来标记该文档已经被删除了。")]),n("li",[s._v("ES在segment中搜索时，可以搜索到该文档，但是该文档已经被标记为删除了。")]),n("li",[s._v("所以luecne在返回结果中会把删除的文档踢出。")]),n("li",[s._v("ES会有后台线程根据luecne的合并规则定期进行segment mering合并操作，删除文档在合并segment的时候，才会被真正的删除。")])]),n("h1",[s._v("6、字段格式")]),n("h2",[s._v("6.1、text")]),n("blockquote",[n("p",[s._v("按照规则分词，至少分词1个词，做全文检索（不要存放空值，会导致性能浪费）。")]),n("p",[s._v("默认是按照standard。")]),n("p",[s._v("应用场景：用于分词检索场景。")])]),n("h2",[s._v("6.2、keyword")]),n("blockquote",[n("p",[s._v("不分词，仅仅一个词，作为一个整体查询。查询效率高，早期版本中，没有这个类型，用string类型替代。")]),n("p",[s._v("应用场景：固定文本，无需进行全文检索，如：城市，姓名，类型等。")])]),n("p",[n("strong",[s._v("总结：Text，keyword：使用的是倒排索引。")])]),n("h2",[s._v("6.3、数值类型")]),n("h3",[s._v("6.3.1、整数")]),n("blockquote",[n("p",[s._v("Long， Integer，Short，Byte，")])]),n("h3",[s._v("6.3.2、浮点数")]),n("blockquote",[n("p",[s._v("Double ，Float，Half Float，Scaled float（缩放浮点类型，解决浮点类型计算精度丢失的问题。）")])]),n("p",[s._v("scaled float 是基于 long 类型实现的。需要指定 scaling_factor。")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-shell"}},[s._v('POST index_/_doc/_id\n{\n\t"mappings": {\n\t\t"properties": {\n\t\t\t"income": {\n\t\t\t\t"type": "scaled_float",\n\t\t\t\t"scaling_facor": 100\n\t\t\t},\n\t\t\t"outcome": {\n                "type": "scaled_float",\n                "scaling_facor": 100\n            }\n\t\t}\n\t}\n}\n')])]),n("h2",[s._v("6.4、时间类型")]),n("blockquote",[n("p",[s._v("在定义时间类型时，一定要定义时间格式化（fromat），防止后面上一些问题。建议使用UTC时间格式。")])]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-shell"}},[s._v('PUT _index/_doc/_id\n{\n\t"mappings": {\n\t\t"properties": {\n\t\t\t"createdate": {\n\t\t\t\t"type": "date"\n\t\t\t},\n\t\t\t"regTime": {\n\t\t\t\t"type": "date",\n\t\t\t\t"format": "yy-MM-dd\'T\'HH:mm:ss.SSS"\n\t\t\t}\n\t\t}\n\t}\n}\n')])]),n("p",[n("strong",[s._v("总结：数值类型和时间类型，采用的BKD树算法，底层存储压缩。")])]),n("h1",[s._v("7、ES操作")]),n("h2",[s._v("7.1、DDL操作")]),n("p",[s._v("数据库定义语言：这些语句定义了不同的数据段，数据库，表，列，索引等数据库对象的定义。")]),n("h3",[s._v("7.1.1、建表")]),n("p",[s._v("请求：")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-shell"}},[s._v('PUT /_index/type_name\n{\n\t"settings": {\n\t\t"number_of_shards": 5,\n\t\t"number_of_replicas": 1\n\t},\n\t"mappings": {\n\t\t"type_name": {\n\t\t\t"dynamic": "strict",\n\t\t\t"properties": {\n\t\t\t\t....\n\t\t\t}\n\t\t}\n\t}\n}\n')])]),n("p",[n("strong",[s._v("字段说明：")])]),n("ul",[n("li",[s._v("properties：字段表示： "),n("ul",[n("li",[s._v("type字段类型：所有字段都会被设置成string类型，存在不好转换的类型，如：boolean类型。")]),n("li",[s._v("stoer是否存储，属性有yes 和 no 。无论是那种值，都会被存储，如果设置成no，在查询的时候，无法使用该项作为查询条件查询的。")]),n("li",[s._v("index是否索引：属性有 not_analyzed（分词不分析），analyzed（分词分析），no（不分词不分析）。")]),n("li",[s._v("search_analyzed：使用具体某一个分词器，不是在存储的分词，而是在查询的时候进行分词。")]),n("li",[s._v("igonre_above对超过igonre_above的字符串，，analyzer 不会进行处理；所以就不会索引起来。导致的结果就是最终搜索引擎搜索不到了。这个选项主要对 not_analyzed 字段有用，这些字段通常用来进行过滤、聚合和排序。而且这些字段都是结构化的，所以一般不会允许在这些字段中索引过长的项。")]),n("li",[s._v('format日期格式要求，例如设置为"yyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis"')])])]),n("li",[s._v("dynamic表示是否使用动态映射，属性： "),n("ul",[n("li",[s._v("true：默认值，动态添加字段。")]),n("li",[s._v("false：忽略新字段。")]),n("li",[s._v("strict：如果发现新字段，抛出异常。")])])]),n("li",[s._v("settings 表示设置： "),n("ul",[n("li",[s._v("num_of_shards：设置分片数量，默认5。")]),n("li",[s._v("num_of_replicas：设置副本数据，默认1。")])])])]),n("h3",[s._v("7.1.2、删表")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-shell"}},[s._v("DELETE /_index\n")])]),n("h3",[s._v("7.1.3、修改")]),n("p",[s._v("ES并不支持直接修改Mapping映射的结构。")]),n("p",[s._v("将原有的数据迁到新的索引上去。")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-shell"}},[s._v('POST _reindex\n{\n\t"source": {\n\t\t"index": "老的索引名称"\n\t},\n\t"dest": {\n\t\t"index": "新的索引名称"\n\t}\n}\n')])]),n("h2",[s._v("7.2、DML操作")]),n("p",[s._v("数据的操作，用于添加，删除，修改和查询数据记录。")]),n("h3",[s._v("7.2.1、新增")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-shell"}},[s._v('POST /_index/type/_id \n{\n\t"字段1": "value",\n\t"字段1": "value",\n\t....\n}\n')])]),n("h3",[s._v("7.2.2、删除")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-shell"}},[s._v("DELETE /_index/type/_id\n")])]),n("h3",[s._v("7.2.3、修改")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-shell"}},[s._v('PUT /_index/type/_id\n{\n\t"字段1": "value",\n\t"字段1": "value",\n\t....\n}\n')])]),n("h3",[s._v("7.2.3、查询")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-shell"}},[s._v('GET /_index/type/_search\n{\n\t"query": {\n\t\t"bool": {\n\t\t\t"must": [\n\t\t\t\t{\n\t\t\t\t\t"match_all": {}\n\t\t\t\t}\n\t\t\t],\n\t\t\t"must_not": [],\n\t\t\t"should": []\n\t\t}\n\t},\n\t"from": 0,\n\t"size": 10,\n\t"sort": [],\n\t"aggs": {}\n}\n')])]),n("p",[s._v("参数说明：")]),n("ul",[n("li",[s._v("query：为查询添加。")]),n("li",[s._v("from：分页查询，相当于 page。")]),n("li",[s._v("size：分页的查询，相当于rows。或者 pageSize")]),n("li",[s._v("sort：排序。")]),n("li",[s._v("aggs：聚合。")])]),n("h1",[s._v("8、查询操作")]),n("p",[s._v("基于语法：")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-shell"}},[s._v('GET /_index/_search\n{\n\t"query": {}, \t# 查询条件\n\t"form": 1,\t \t# 开始页\n\t"size": 10,  \t# page size\n\t"_source": [],\t# 返回的字段\n\t"sort": {},\t\t# 排序\n\t"aggs": {}\t\t# 聚合查询\n}\n')])]),n("p",[s._v("另外还支持一次查询多个索引：")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-shell"}},[s._v("GET /_index1,_index2/_search\n")])]),n("p",[s._v("也可以按照前缀来要匹配索引：")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-shell"}},[s._v("GET /_index*/_search\n")])]),n("p",[s._v("查询到结果集：")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-json"}},[n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("{")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"took"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("4")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\t\t\t\t\t"),n("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 查询消耗的时间，毫秒")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"timed_out"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-literal"}},[n("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("false")])]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\t\t\t"),n("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 查询是否超时")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"_shards"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("{")]),s._v("\t\t\t\t"),n("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 本次查询时，使用到ES分片情况")]),s._v("\n    \t"),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"total"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n    \t"),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"successful"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n    \t"),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"skipped"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n    \t"),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"failed"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"hits"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("{")]),s._v("\t\t\t\t\t"),n("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 返回结果")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"total"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("{")]),s._v("\t\t\t\t"),n("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 匹配的文档数")]),s._v("\n        \t"),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"value"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n             "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"relation"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"eq"')]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"max_score"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1.0")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\t\t"),n("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 匹配的结果中最大分数")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"hits"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("[")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 返回数据集")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("]")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("}")]),s._v("\n")])]),n("p",[s._v("_source用于来设置返回结果集中的字段。")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-shell"}},[s._v('{\n\t"_sorce": ["字段1", "字段2"]\n}\n')])]),n("h2",[s._v("8.1、单个字段匹配")]),n("p",[s._v("通过match实现全文检索：")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-shell"}},[s._v('GET /_index/_search\n{\n\t"query": {\n\t\t"match": {\n\t\t\t"属性": "值"\n\t\t}\n\t}\n}\n')])]),n("p",[s._v("说明：属性就是要查询的字段，值就是需要匹配的值。")]),n("p",[s._v("如果：该属性是text类型，搜索的值会被分词。")]),n("h2",[s._v("8.2、精确匹配单个字段")]),n("p",[s._v("精确匹配就是 查询的条件词，不会被分词。想当于 SQL语句中 等于。")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-shell"}},[s._v('GET /_index/_search\n{\n\t"query": {\n\t\t"term": {\n\t\t\t"属性": "值"\n\t\t}\n\t}\n}\n')])]),n("h2",[s._v("8.3、多个值的精确匹配")]),n("p",[s._v("就是在精确匹配的基础上，可以匹配多个值，相当于SQL中 in。")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-shell"}},[s._v('GET /_index/_search\n{\n\t"query": {\n\t\t"terms": {\n\t\t\t"属性": [\n\t\t\t\t"值1", "值2", ...\n\t\t\t]\n\t\t}\n\t}\n}\n')])]),n("p",[s._v("只要匹配中了一个值，就被选中，出现在结果集中。")]),n("h2",[s._v("8.4、范围查询")]),n("p",[s._v("相当于SQL中范围查询，大于，小于，等于等。")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-shell"}},[s._v('GET /_index/_search\n{\n\t"query": {\n\t\t"range": {\n\t\t\t"属性": {\n\t\t\t\t"gte": 10,\n\t\t\t\t"lte": 20\n\t\t\t}\n\t\t}\n\t}\n}\n')])]),n("p",[s._v("一般范围查询是针对数字类型，时间类型。")]),n("p",[s._v("操作服：")]),n("table",[n("thead",[n("tr",[n("th",[s._v("操作符")]),n("th",[s._v("描述")])])]),n("tbody",[n("tr",[n("td",[s._v("gt")]),n("td",[s._v("大于")])]),n("tr",[n("td",[s._v("gte")]),n("td",[s._v("大于等于")])]),n("tr",[n("td",[s._v("lt")]),n("td",[s._v("小于")])]),n("tr",[n("td",[s._v("lte")]),n("td",[s._v("小于等于")])])])]),n("h2",[s._v("8.5、组合查询")]),n("p",[s._v("组合查询就是多个字段的查询。")]),n("h3",[s._v("8.5.1、基本语法")]),n("p",[s._v("在ES中 bool 查询就是用来组合查询，及boolean查询，相当于SQL中 and 和 or。")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-shell"}},[s._v('GET /_index/_search\n{\n\t"query": {\n\t\t"bool": {\n\t\t\t"must": [],\n\t\t\t"must_not": [],\n\t\t\t"should": []\n\t\t}\n\t}\n}\n')])]),n("p",[s._v("说明：")]),n("ul",[n("li",[s._v("must：类似于SQL中and，是的必须包含的。")]),n("li",[s._v("must_not：于must相反的，就是必须不包含的。")]),n("li",[s._v("should：类似于SQL中OR，匹配其中任意一个即可。")])]),n("blockquote",[n("p",[s._v("上面的查询都是对单个字段的查询，都可以用在bool中的进行组合查询。")])]),n("h3",[s._v("8.5.2、must条件")]),n("p",[s._v("类似于SQL中and，必须匹配的条件。")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-shell"}},[s._v('GET /_index/_search\n{\n\t"query": {\n\t\t"bool": {\n\t\t\t"must": [\n\t\t\t\t{\n\t\t\t\t\t"term": {\n\t\t\t\t\t\t"属性": "值"\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t.....\n\t\t\t\t}\n\t\t\t]\n\t\t}\n\t}\n}\n')])]),n("h3",[s._v("8.5.3、must_not")]),n("p",[s._v("于must的条件相反。")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-shell"}},[s._v('GET /_index/_search\n{\n\t"query": {\n\t\t"bool": {\n\t\t\t"must_not": [\n\t\t\t\t{\n\t\t\t\t\t"term": {\n\t\t\t\t\t\t"属性": "值"\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t....\n\t\t\t\t}\n\t\t\t]\n\t\t}\n\t}\n}\n')])]),n("h3",[s._v("8.5.4、should")]),n("p",[s._v("相当SQL中or，匹配其中任意一个即可。")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-shell"}},[s._v('GET /_index/_search\n{\n\t"query": {\n\t\t"bool": {\n\t\t\t"should": [\n\t\t\t\t{\n\t\t\t\t\t"term": {\n\t\t\t\t\t\t"属性": "值"\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t...\n\t\t\t\t}\n\t\t\t]\n\t\t}\n\t}\t\n}\n')])]),n("h2",[s._v("8.6、排序")]),n("p",[s._v("ES默认是按照 相关度进行排序的，我们也可以自己指定排序方式。")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-shell"}},[s._v('GET /_index/_search\n{\n\t"query": {\n\t\t...\n\t},\n\t"sort": [\n\t\t{\n\t\t\t"字段名称": {\n\t\t\t\t"order": "desc"\n\t\t\t}\n\t\t},\n\t\t{\n\t\t\t"字段名称": {\n\t\t\t\t"order": "asc"\n\t\t\t}\n\t\t}\n\t]\n}\n')])]),n("p",[s._v("支持多个字段的排序，在排序时，asc 表示升序，desc 表示降序。")]),n("h1",[s._v("9、全文检索")]),n("blockquote",[n("p",[s._v("全文检索是ES的关键特效之一，ES通过分词处理，相关度计算可以来解决文章检索，ES内置了一些相关度算法，例如：TF/IDF算法，基本原理就是，如果一个关键词在一遍文章中出现的次数越多，就表示该词对这篇文章越重要。当然，停用词排除掉。")])]),n("p",[s._v("分词的目的：")]),n("blockquote",[n("p",[s._v("主要就是提取搜索的关键词。像在百度上搜索时，你可以输入了一句话，但是百度匹配的是这句话中的几个关键词。")])]),n("h2",[s._v("9.1、默认全文检索")]),n("p",[s._v("默认情况下，使用全文检索很简单，上面也提到了，默认对 text 类型的字段会进行全文检索。")]),n("p",[n("strong",[s._v("ES对 text 类型的字段处理过程：")])]),n("blockquote",[n("p",[s._v("在插入数据时，首先会对文本数据进行分词，然后，根据分词的结果去检索文档。")]),n("p",[s._v("当我们在搜索 text 字段的时候，就会先对搜索条件进行分词处理，然后根据分词的结果去搜索。")])]),n("h2",[s._v("9.2、分词器")]),n("p",[s._v("ES默认的分词器是standard，对英文的支持比较好，但是对中文的支持较差，因为是按照空格进行分词的，但是对文中分词是一个字就是一个次。")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-shell"}},[s._v('GET /_analyze\n{\n\t"text": "需要分词的句子",\n\t"analyzer": "分词器"\n}\n')])]),n("p",[n("strong",[s._v("指定分词器")])]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-shell"}},[s._v('PUT /_index\n{\n\t"mappings": {\n\t\t"properties": {\n\t\t\t"title": {\n\t\t\t\t"type": "text",\n\t\t\t\t"analyzer": "smartcn"\n\t\t\t}\n\t\t}\n\t}\n}\n')])]),n("p",[s._v("需要在定义text类型的时候，添加额外的一个配置，指定分词器。")]),n("p",[n("strong",[s._v("分词器有： smartcn， IK分词器，都支持中文分词。")])]),n("h1",[s._v("10、深度分页")]),n("h2",[s._v("10.1、什么是深度分页")]),n("p",[s._v("在ES中分页是采用from + size 的方式来来实现分页的。")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":""}},[s._v('GET index_name/_search\n{\n  "from": 0,\n  "size": 5\n}\n')])]),n("p",[n("img",{attrs:{src:a("87f1"),alt:""}})]),n("p",[s._v("如果查询前 10000 条数据的时候，没有任何问题，但是查询数据超过了10000条数据后，就会报错。")]),n("p",[n("img",{attrs:{src:a("133f"),alt:""}})]),n("p",[s._v("报错信息解释了：查询的结果超过了10000最大值，那么存在一个问题：查询数据是 5 条数据，为啥计算最大值要加上from的数量。而且ES是PB级数据秒级查询。按理说几亿数据都没有问题，那为啥现在 10000 条数据就报错了。")]),n("p",[n("strong",[s._v("ES为了性能，限制了我们分页深度。目前ES支持的最大分页深度：max_result_window=10000。也就是说，我们获取数据不能超过10000，超过10000条就会报错。")])]),n("p",[s._v("怎么解决这个问题了。可以调整最大窗口（window值）。")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":""}},[s._v('PUT movies/_settings\n{ \n    "index" : { \n        "max_result_window" : 20000\n    }\n}\n')])]),n("p",[n("strong",[s._v("这种方式可以暂时解决问题，因为数据量越来越大的时候，分页深度就越来越大，容易造成OOM。")])]),n("h2",[s._v("10.2、From+size为啥会造成OOM")]),n("p",[s._v("协调节点或者client节点，需要讲请求发送到所有分片。每一个分片把from+size个结果，返回给协调节点或者client节点。协调节点或者client节点会把结果进行合并，如果有n个分片，那么查询的数据就是n * （from + size）条数据，如果from很大的时候，就会造成OOM或者资源浪费。")]),n("p",[n("img",{attrs:{src:a("8321"),alt:""}})]),n("p",[s._v("例子：")]),n("ul",[n("li",[s._v("如果请求第20页，ES就会取出所有分片上第1页到第20页上的所有文档数据。并做出排序，最终再取出from到size条结果作为最总结果输出。")]),n("li",[s._v("如果有16个分片，需要在协调节点上计算到数据总量，分片数量 * （from + size）条记录，即：16 * （20 + 10）条记录，在做一次排序，然后在获取from到size的数据。")]),n("li",[s._v("所以，当索引非常大的时候，千万级，亿级的时候，使用from + size的方式时，就更容易出现OOM，即便不是OOM，也消耗CPU和内存资源消耗。")])]),n("p",[n("strong",[s._v("结论：")])]),n("ul",[n("li",[n("strong",[s._v("max_result_window越大，副本越多，越容易出现OOM。一般不建议修改window值。")])])]),n("h2",[s._v("10.3、Scroll 滚动游标原理")]),n("p",[s._v("scroll 滚动游标查询 也叫 快照查询，ES为了避免深度分页，不允许使用from+size查询来查询10000条后的数据。所以就提供了scroll滚动游标查询。")]),n("h3",[s._v("10.3.1、原理")]),n("p",[s._v("对一次查询生成一个游标 scroll_id，后续查询只需要根据这个游标 scroll_id去取数据，直接结果集中返回到hits字段为空，就表示遍历结束。")]),n("p",[s._v("scroll_id的生成可以理解为建立一个临时历史快照，或者可以理解成一个保存了文档数据的临时文件，快照文件形成之后，当原文档数据进行增删改查等操作时，不会响应到这个临时快照。")]),n("p",[s._v("理解：")]),n("ul",[n("li",[s._v("使用scroll就是一次把要用的数据全部查询出来，缓存起来。")]),n("li",[s._v("在遍历的时候，从这个快照中获取数据，分批取出。游标可以增加性能的，比from+size好。")]),n("li",[s._v("如果要做深度分页时，from+size每次搜索的时候，都必须重新排序，非常浪费资源，而且非常容易OOM。")])]),n("h3",[s._v("10.3.2、Scroll滚动游标使用过程")]),n("p",[s._v("使用Scroll滚动游标分页读取数据的时候过程如下：")]),n("ul",[n("li",[s._v("先获取第一个scroll_id，url参数包括 /index/_type/ 和 scroll。")]),n("li",[s._v("scroll字段指定了scroll_id 的有效生存期，以分钟为单位，过期后，es会自动清除快照数据文件。")]),n("li",[s._v("如果文档不需要指定特定排序，可以指定按照文档创建的时间返回，会提高迭代效率。")])]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":""}},[s._v('curl -XGET 200.200.107.232:9200/product/info/_search?pretty&scroll=2m -d \n\'{"query":{"match_all":{}}, "size": 10, "sort": ["_doc"]}\'\n')])]),n("p",[s._v("结果：")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-json"}},[n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"_scroll_id"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"cXVlcnlBbmRGZXRjaDsxOzg3OTA4NDpTQzRmWWkwQ1Q1bUlwMjc0WmdIX2ZnOzA7"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"took"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"timed_out"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-literal"}},[n("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("false")])]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"_shards"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"total"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"successful"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"failed"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"hits"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("{")]),s._v("..."),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("}")]),s._v("\n")])]),n("p",[s._v("参数："),n("code",{pre:!0},[s._v("&scroll=2m")]),s._v(" 表示")]),n("blockquote",[n("p",[s._v("表示 scroll id的生存时间为2分钟，scroll 就是把一次查询结果查询出来后，缓存一定的时间，如果scroll=2m则把查询结果在下一次请求上来时暂存2分钟，response比传统的返回一个scroll id，下次带着这个scroll id 即可查询到这个存储在结果。")])]),n("p",[s._v("后续翻页，通过上一次查询返回的scroll id 来不断的去下一页，当请求指定的 scroll id 的时候，就不需要 /index/type 等信息。")]),n("p",[s._v("如果scroll id 的生存期很长的时候，那么每一次返回的scroll id 都一样，直到该scroll id 过期，才会返回一个新的scroll id。")]),n("p",[s._v("每次读取一页都会重新设置scroll id 的生存期时间，所以这个时间只需要满足读取当前页就可以，不需要满足读取所以数据的时间，")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":""}},[s._v("curl -XGET '200.200.107.232:9200/_search/scroll?scroll=1m&scroll_id=cXVlcnlBbmRGZXRjaDsxOzg4NDg2OTpTQzRmWWkwQ1Q1bUlwMjc0WmdIX2ZnOzA7'\n")])]),n("p",[s._v("结果：")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-json"}},[n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"_scroll_id"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"cXVlcnlBbmRGZXRjaDsxOzk1ODg3NDpTQzRmWWkwQ1Q1bUlwMjc0WmdIX2ZnOzA7"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"took"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("106")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"_shards"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"total"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"successful"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"failed"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"hits"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"total"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("22424")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"max_score"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1.0")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"hits"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("{")]),s._v("\n                "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"_index"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"product"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n                "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"_type"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"info"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n                "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"_id"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"did-519392_pdid-2010"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n                "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"_score"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1.0")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n                "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"_routing"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"519392"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n                "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"_source"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("{")]),s._v("\n                    ....\n                "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("}")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("}")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("]")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("}")]),s._v("\n")])]),n("p",[s._v("注意：")]),n("blockquote",[n("p",[s._v("使用初始化返回的 scroll id 来进行请求，每一次请求都会继续返回初始化中未读完的数据，并且返回一个scroll id，这个scroll id可以会改变，因为每一次请求都会带着上一次返回的scroll id。")])]),n("p",[n("strong",[s._v("每一次请求发送scroll id时，都会重新刷新这个scroll的开启时间，以防止不小心超时导致数据获取不完整。")])]),n("p",[s._v("如果没有数据的时候，就会返回一个空的hits集合，可以用这个来判断是否遍历完这个数据集。")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":""}},[s._v("curl -XGET '200.200.107.232:9200/_search/scroll?scroll=1m&scroll_id=cXVlcnlBbmRGZXRjaDsxOzg4NDg2OTpTQzRmWWkwQ1Q1bUlwMjc0WmdIX2ZnOzA7'\n")])]),n("p",[s._v("结果：")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-json"}},[n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"_scroll_id"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"cXVlcnlBbmRGZXRjaDsxOzk1ODg3NDpTQzRmWWkwQ1Q1bUlwMjc0WmdIX2ZnOzA7"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"took"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("106")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"_shards"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"total"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"successful"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"failed"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"hits"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"total"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("22424")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"max_score"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1.0")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"hits"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("]")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("}")]),s._v("\n")])]),n("h3",[s._v("10.3.3、Scroll id 的清理")]),n("p",[s._v("scroll id的存在会消耗大量的资源来保存当前查询的结果集映像，并且会占用文件描述符。为了防止打开scroll太多，从而导致问题，不允许用户打开滚动超过某一个限制。")]),n("p",[n("strong",[s._v("默认情况下，打开scroll的数量是500，可以使用search.max_open_scroll_context集群设置来更新该限制。")])]),n("p",[s._v("获取有多少个scroll滚动游标：")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":""}},[s._v("GET /_nodes/stats/indices/search\n")])]),n("p",[s._v("虽然ES有自动清理scroll的机制，但是在使用中，还是尽量手动清理scroll id。")]),n("p",[s._v("使用ES提供的clean api 来删除指定的scroll id。")]),n("ul",[n("li",[n("p",[s._v("删除指定多个scroll id。")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":""}},[s._v('curl -XDELETE 127.0.0.1:9200/_search/scroll -d \n\'{"scroll_id" : ["cXVlcnlBbmRGZXRjaDsxOzg3OTA4NDpTQzRmWWkwQ1Q1bUlwMjc0WmdIX2ZnOzA7"]}\'\n')])])]),n("li",[n("p",[s._v("删除掉索引上的所有的scroll id。")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":""}},[s._v("curl -XDELETE 127.0.0.1:9200/_search/scroll/_all\n")])])]),n("li",[n("p",[s._v("查询当前所有的scroll的状态")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":""}},[s._v("curl -XGET 127.0.0.1:9200/_nodes/stats/indices/search?pretty\n")])]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-json"}},[n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"cluster_name"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"200.200.107.232"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"nodes"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"SC4fYi0CT5mIp274ZgH_fg"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("{")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"timestamp"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1514346295736")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"name"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"200.200.107.232"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"transport_address"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"200.200.107.232:9300"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"host"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"200.200.107.232"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"ip"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("[")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"200.200.107.232:9300"')]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"NONE"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"indices"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"search"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("{")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"open_contexts"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"query_total"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("975758")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"query_time_in_millis"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("329850")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"query_current"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"fetch_total"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("217069")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"fetch_time_in_millis"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("84699")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"fetch_current"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"scroll_total"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("5348")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"scroll_time_in_millis"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("92712468")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"scroll_current"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("}")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("}")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("}")]),s._v("\n")])])])]),n("h2",[s._v("10.4、Search after")]),n("p",[s._v("上述的scroll search的方式，官方不建议不用于实时文档查询。")]),n("ul",[n("li",[s._v("因为每一个scroll id 生成一个历史快照文件，对于数据的变更不会反应到这个快照上。")])]),n("p",[s._v("scroll方式往往用于非实时数据处理大量数据的情况，比如要进行数据迁移或者索引变更之类的。")]),n("p",[n("strong",[s._v("ES给出了search after的方式，这是在 >= 5.0的版本才提供的功能。")])]),n("h3",[s._v("10.4.1、Search after 分页")]),n("p",[s._v("search after和 scroll 分页还是有一些区别的：")]),n("ul",[n("li",[s._v("首先它根据上一页的最后条数据来确定下一页的位置，同时在分页请求的过程中，如果有索引数据的CRUD，这些变更也会实时的反应到游标上。")]),n("li",[s._v("为了找到每一页的最后一条数据，每一个文档必须有一个全局唯一值，官方推荐使用文档id作为全局唯一值，")])]),n("h3",[s._v("10.4.2、Search after的使用")]),n("p",[s._v("第一页的数据请求和正常请求一样的。")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":""}},[s._v('curl -XGET 127.0.0.1:9200/order/info/_search\n{\n    "size": 10,\n    "query": {\n        "term" : {\n            "did" : 519390\n        }\n    },\n    "sort": [\n        {"date": "asc"},\n        {"_id": "desc"}\n    ]\n}\n')])]),n("p",[n("strong",[s._v("在第二页请求中，需要使用到第一页返回的结果的最后一条数据的值，加上search after字段来取下一页。")])]),n("p",[n("strong",[s._v("注意：使用search after的时候，需要将from设置为0或-1。")])]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":""}},[s._v('curl -XGET 127.0.0.1:9200/order/info/_search\n{\n    "size": 10,\n    "query": {\n        "term" : {\n            "did" : 519390\n        }\n    },\n    "search_after": [1463538857, "tweet#654323"],\n    "sort": [\n        {"date": "asc"},\n        {"_uid": "desc"}\n    ]\n}\n')])]),n("p",[s._v("总结：search after 使用于深度分页 + 排序，因为每一页的数据都依赖于上一页的最后一条数据，所以无法分页跳转。并且返回的数据始终是最新的数据，在分页过程中数据的位置有可能有变更。")]),n("h3",[s._v("10.4.3、Search after 深度翻页")]),n("p",[s._v("每一个文档都有一个唯一值来作为排序的仲裁器，否则，具有相同排序值的文档的排序是未定义的。")]),n("p",[n("strong",[s._v("建议使用文档id字段来作为一个唯一值。")])]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":""}},[s._v('POST index/_search\n{\n    "size": 10,\n    "query": {\n        "match" : {\n            "title" : "es"\n        }\n    },\n    "sort": [\n        {"date": "asc"},\n        {"_id": "desc"}\n    ]\n}\n')])]),n("p",[s._v("结果：")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":"",class:"language-json"}},[n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("{")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"took"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("29")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"timed_out"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-literal"}},[n("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("false")])]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"_shards"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"total"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"successful"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"skipped"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"failed"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"hits"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"total"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("{")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"value"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("5")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"relation"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"eq"')]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"max_score"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-literal"}},[n("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("null")])]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"hits"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("[")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("{")]),s._v("\n            ...\n            "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"sort"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("[")]),s._v("\n              ...\n            "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("]")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("{")]),s._v("\n            ...\n            "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"sort"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("[")]),s._v("\n              "),n("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("124648691")]),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v(",")]),s._v("\n              "),n("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"624812"')]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("]")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("}")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("]")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"hljs-punctuation"}},[s._v("}")]),s._v("\n")])]),n("p",[s._v("上面的请求会为每一个文档返回一个包含sort排序值的数组。这些sort排序值可以备用于 search after 参数里以便获取下一页的数据。")]),n("p",[s._v("例：")]),n("pre",{pre:!0},[n("code",{pre:!0,attrs:{"v-pre":""}},[s._v('GET twitter/_search\n{\n    "size": 10,\n    "query": {\n        "match" : {\n            "title" : "es"\n        }\n    },\n    "search_after": [124648691, "624812"],\n    "sort": [\n        {"date": "asc"},\n        {"_id": "desc"}\n    ]\n}\n')])]),n("p",[s._v("search after 的要点：")]),n("ul",[n("li",[n("p",[s._v("它必须要先指定排序，在排序的基础上指定坐标。")])]),n("li",[n("p",[s._v("必须从第一页开始往下翻页。")])]),n("li",[n("p",[s._v("从第一页开始以后每一次都带着 search_after = lastEmittedDocFieldValue 从而为无状态一个的状态。")]),n("p",[s._v('"search_after": [124648691, "624812"], [124648691, "624812"]为上一页最后一个文档的 排序字段值'),n("code",{pre:!0},[s._v("lastEmittedDocFieldValue")]),s._v("， 这一次查询带上"),n("code",{pre:!0},[s._v("lastEmittedDocFieldValue")])])])]),n("h2",[s._v("10.5、总结：")]),n("ul",[n("li",[s._v("传统方式： "),n("ul",[n("li",[s._v("使用from+size的方式，可以实时获取数据，但是不能进行深度分页。")])])]),n("li",[s._v("Scroll 游标滚动： "),n("ul",[n("li",[s._v("使用这种方法可以实现深度分页，但是数据不能实时更新，可以实现跳页，通过scroll id标记。")])])]),n("li",[s._v("search after： "),n("ul",[n("li",[s._v("先指定排序后，通过标记来获取下一页的数据，数据实时更新，但是不能跳页查询。")])])])]),n("h1",[s._v("11、ES优化")]),n("h2",[s._v("11.1、批量提交")]),n("ul",[n("li",[s._v("当有大量数据需要插入到ES中时，可以采用批量提交的方式查询。")]),n("li",[s._v("优化size大小，需要根据文档大小和服务器的性能来定。")])]),n("h2",[s._v("11.2、增加Refresh时间间隔")]),n("ul",[n("li")])])])])}],p=a("2877"),l={},e=Object(p["a"])(l,n,r,!1,null,null,null);t["default"]=e.exports},f80e:function(s,t,a){s.exports=a.p+"img/1677134769658.06b5d9ef.jpg"}}]);
//# sourceMappingURL=chunk-5237e37a.e0de7cf8.js.map